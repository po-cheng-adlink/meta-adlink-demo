# short-description: Create an EFI disk image with systemd-boot/grub-efi
# long-description: Creates a partitioned EFI disk image that the user
# can directly dd to boot media. The selected bootloader is systemd-boot/grub-efi.
# It also includes intel-microcode as an initrd for early update support.
# Based on OE-core's systemd-bootdisk.wks file.
# WIC_IMAGE_BOOT_LOADER = [systemd-boot|grub-efi]

part /boot --source bootimg-efi --sourceparams="loader=${WIC_IMAGE_BOOT_LOADER},initrd=microcode.cpio" --ondisk ${WIC_FSTAB_BLKDEV} --label msdos --active --align ${IMAGE_ROOTFS_ALIGNMENT} --use-uuid

part / --source rootfs --ondisk ${WIC_FSTAB_BLKDEV} --fstype=ext4 --label platform --align ${IMAGE_ROOTFS_ALIGNMENT} --use-uuid

part ${WIC_DATA_PARTITION_MOUNT_PATH} --source datafs --sourceparams="file=${WIC_DATA_PARTITION_IMAGE}" --ondisk ${WIC_FSTAB_BLKDEV} --fstype=ext4 --fsoptions "defaults" --label ${WIC_DATA_PARTITION_LABEL} --align ${IMAGE_ROOTFS_ALIGNMENT} --size ${WIC_PARTITION_SIZE}

part swap --ondisk ${WIC_FSTAB_BLKDEV} --size 44 --label swap1 --fstype=swap --use-uuid

bootloader --ptable ${WIC_PARTITION_TABLE_TYPE} --timeout=5 --append=" rootfstype=ext4 "
